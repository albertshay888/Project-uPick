<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>uPick</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
        crossorigin="anonymous">

     

    <style>
        .strike {
            color: red;
        }

      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #right-panel {
        font-family: 'Roboto','sans-serif';
        line-height: 30px;
        padding-left: 10px;
      }

      #right-panel select, #right-panel input {
        font-size: 15px;
      }

      #right-panel select {
        width: 100%;
      }

      #right-panel i {
        font-size: 12px;
      }
      #right-panel {
        font-family: Arial, Helvetica, sans-serif;
        position: absolute;
        right: 5px;
        top: 60%;
        margin-top: -195px;
        height: 330px;
        width: 200px;
        padding: 5px;
        z-index: 5;
        border: 1px solid #999;
        background: #fff;
      }
      h2 {
        font-size: 22px;
        margin: 0 0 5px 0;
      }
      ul {
        list-style-type: none;
        padding: 0;
        margin: 0;
        height: 271px;
        width: 200px;
        overflow-y: scroll;
      }
      li {
        background-color: #f1f1f1;
        padding: 10px;
        text-overflow: ellipsis;
        white-space: nowrap;
        overflow: hidden;
      }
      li:nth-child(odd) {
        background-color: #fcfcfc;
      }
      #more {
        width: 100%;
        margin: 5px 0 0 0;
      }
 
    </style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/5.5.9/firebase.js"></script>
<script  async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBW2P5znpC7asNyzcITnoDRVOutOYjmPzU&libraries=places">

    function initialize() {
        var mapOptions = {
            center: {lat: -34.397, lng: 150.664},
            zoom: 8
            };

            var map = new google.maps.Map(document.getElementsByClassName("map-page"),
            mapOptions);
        };

        google.maps.events.addDomListener(window, 'load', initialize);
</script>


</head>






<body>
    
    <div class="container">
        <div class="row">
            <div class="cuisine-display button">
            </div>
        </div>
    </div>
    <br>
    <!-- <p class="correct-answer">The pick: -->
            <div class="correct-answer" id="correct-answer-id"></div>
            <br>

            <div class="search-results"></div>
            
            <hr>
            <div>
            <h3 class="">Trending:
              <strong>
                <span id="connected-viewers"></span>
              </strong> currently on uPick.</h3>
            </div>
       
  <div class="map-page">
            <!-- <div class="map"></div>
                <div class="right-panel">
                <h2>Results</h2>
                <ul class="places"></ul>
                <button class="more">More results</button>
                </div> -->

</div>

    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.5.9/firebase.js"></script>
    <script  async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBW2P5znpC7asNyzcITnoDRVOutOYjmPzU&libraries=places"
   ></script> -->
    <!-- <script src="mapslogic2.js" async defer></script> -->
    <!-- https://maps.googleapis.com/maps/api/place/nearbysearch/output?parameters -->
 



<script>
// Initialize Firebase

 var config = {
        apiKey: "AIzaSyBMHL9um8Nsoy3vj8CPWIZuaG3QvKDgYys",
        authDomain: "upick-d5758.firebaseapp.com",
        databaseURL: "https://upick-d5758.firebaseio.com",
        projectId: "upick-d5758",
        storageBucket: "upick-d5758.appspot.com",
        messagingSenderId: "989534447107"
      };
      firebase.initializeApp(config);
// var config = {
//     apiKey: "AIzaSyAV-grm0Ao9DBqUZT6mCgIxD4nA1oM0NCE",
//     authDomain: "testproject-ecfdb.firebaseapp.com",
//     databaseURL: "https://testproject-ecfdb.firebaseio.com",
//     projectId: "testproject-ecfdb",
//     storageBucket: "testproject-ecfdb.appspot.com",
//     messagingSenderId: "1009715215096"
//   };
//   firebase.initializeApp(config);

      // Create a variable to reference the database

       var database = firebase.database();    

       // -----------------------------

// connectionsRef references a specific location in our database.
// All of our connections will be stored in this directory.
var connectionsRef = database.ref("/connections");


// '.info/connected' is a special location provided by Firebase that is updated
// every time the client's connection state changes.
// '.info/connected' is a boolean value, true if the client is connected and false if they are not.
var connectedRef = database.ref(".info/connected");

// When the client's connection state changes...
connectedRef.on("value", function(snap) {

  // If they are connected..
  if (snap.val()) {

    // Add user to the connections list.
    var con = connectionsRef.push(true);
    // Remove user from the connection list when they disconnect.
    con.onDisconnect().remove();
  }
});

// When first loaded or when the connections list changes...
connectionsRef.on("value", function(snap) {

  // Display the viewer count in the html.
  // The number of online users is the number of children in the connections list.
  $("#connected-viewers").text(snap.numChildren());
});
    
// var cuisines = [{food: 'American', eliminated: false },
//                 {food: 'Chinese', eliminated: false },
//                 {food: 'Filipino', eliminated: false },
//                 {food: 'Indian', eliminated: false },
//                 {food: 'Italian', eliminated: false },
//                 {food: 'Japanese', eliminated: false },
//                 {food: 'Korean', eliminated: false },
//                 {food: 'Thai', eliminated: false },
//                 {food: 'Mexican', eliminated: false },
//                 {food: 'Vietnamese', eliminated: false }]

var cuisineButton;
var finalButton;
     




database.ref("/cuisines").on("value", function(snapshot) {
    cuisines = snapshot.val().cuisines;
    var counter = 0;
    var remainingStuff = [];
    cuisines.forEach(function(cuisine){ 
        if(!cuisine.eliminated){
            counter++
            remainingStuff.push(cuisine.food);
        } 
    });
    if(counter === 1){
        var winner = remainingStuff.pop()
        // alert("We have a winner! We gettin' " + winner + " food tonight!!" )
        // gameOver();
        console.log(winner);
        $(".cuisine-display").hide();
        $(".correct-answer").append(winner);
        $(".search-results").append("Show results for " + winner);
        

    }
    createButtons(cuisines);
}); 

// click handler to start game and generate cuisine buttons
$('#start-game').on('click', function () {
    resetGameForAll();
});

$('.search-results').on('click', function(){
       //dynamically show map
       var showMap = $("<div>");
        showMap.addClass("map");
       
        var mapResults = $("<div>");
            mapResults.addClass("searchResults");

            var results = $("<ul>");
                results.addClass("places");

                showMap.append(mapResults, results);

                $(".map-page").append(showMap);
})




function resetGameForAll(){
    var cuisines = [{food: 'American', eliminated: false },
                    {food: 'Chinese', eliminated: false },
                    {food: 'Filipino', eliminated: false },
                    {food: 'Indian', eliminated: false },
                    {food: 'Italian', eliminated: false },
                    {food: 'Japanese', eliminated: false },
                    {food: 'Korean', eliminated: false },
                    {food: 'Thai', eliminated: false },
                    {food: 'Mexican', eliminated: false },
                    {food: 'Vietnamese', eliminated: false }];

    database.ref('/cuisines').set({
        cuisines: cuisines
    });
    createButtons(cuisines)
}

//when user decides to eliminate one of the cusines
$(document).on('click', '.cuisine-button', function () {
    var elimCu = $(this).attr("data-name");
    for(var i = 0; i< cuisines.length; i++){
        if(elimCu === cuisines[i].food){
            cuisines[i].eliminated = true;
            database.ref("/cuisines").set({
                cuisines: cuisines
            })
        }
    }
});


function createButtons(cuisines){
    $('.cuisine-display').empty();
    for (var i = 0; i < cuisines.length; i++) {
        if(!cuisines[i].eliminated){
            cuisineButton = $('<button>');
            cuisineButton.addClass('cuisine-button');
            cuisineButton.attr('data-name', cuisines[i].food);
            cuisineButton.text(cuisines[i].food);
        $('.cuisine-display').append(cuisineButton);
        } else {
            cuisineButton = $('<button>');
            cuisineButton.addClass('cuisine-button strike');
            cuisineButton.attr('data-name', cuisines[i].food);
            cuisineButton.text(cuisines[i].food);
            $('.cuisine-display').append(cuisineButton);
        }
    } 
};

function gameOver(){
    resetGameForAll();
}
















//PART 2 STARTS HERE (GOOGLE API, LOCATION, PLACES)

//var winner -> feed into google place search "restaurant" (built in). Write conditional to filter to show only winner cuisine results. 


// This example requires the Places library. Include the libraries=places
// parameter when you first load the API. For example:
// <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places">


// 1. search!
var map;
var service;
var infowindow;
var google;

function initialize() {
  var pyrmont = new google.maps.LatLng(-33.8665433,151.1956316);

  map = new google.maps.Map(document.getElementsByClassName('map'), {
      center: pyrmont,
      zoom: 15
    });

  var request = {
    location: pyrmont,
    radius: '300',
    query: 'restaurant',
    keyword: winner,
  };

  service = new google.maps.places.PlacesService(map);
  service.textSearch(request, callback);
}

function callback(results, status) {
  if (status == google.maps.places.PlacesServiceStatus.OK) {
    for (var i = 0; i < results.length; i++) {
      var place = results[i];
      createMarker(results[i]);
    }
  }
}


// 2. get results

function initMap() {
  // Create the map.
  var pyrmont = {lat: -33.866, lng: 151.196};
  map = new google.maps.Map(document.getElementsByClassName('map'), {
    center: pyrmont,
    zoom: 17
  });

  // Create the places service.
  var service = new google.maps.places.PlacesService(map);
  var getNextPage = null;
  var moreButton = document.getElementsByClassName('more');
  moreButton.onclick = function() {
    moreButton.disabled = true;
    if (getNextPage) getNextPage();
  };

  // Perform a nearby search.
  service.nearbySearch(
      {location: pyrmont, radius: 300, type: ['restaurant']},
      function(results, status, pagination) {
        if (status !== 'OK') return;

        createMarkers(results);
        moreButton.disabled = !pagination.hasNextPage;
        getNextPage = pagination.hasNextPage && function() {
          pagination.nextPage();
        };
      });
}

function createMarkers(places) {
  var bounds = new google.maps.LatLngBounds();
  var placesList = document.getElementsByClassName('places');

  for (var i = 0, place; place = places[i]; i++) {
    var image = {
      url: place.icon,
      size: new google.maps.Size(71, 71),
      origin: new google.maps.Point(0, 0),
      anchor: new google.maps.Point(17, 34),
      scaledSize: new google.maps.Size(25, 25)
    };

    var marker = new google.maps.Marker({
      map: map,
      icon: image,
      title: place.name,
      position: place.geometry.location
    });

    var li = document.createElement('li');
    li.textContent = place.name;
    placesList.appendChild(li);

    bounds.extend(place.geometry.location);
  }
  map.fitBounds(bounds);
}

//3. get search result details

service = new google.maps.places.PlacesService(map);
service.getDetails(request, callback);

var request = {
  placeId: 'ChIJN1t_tDeuEmsRUsoyG83frY4',
  fields: ['name', 'rating', 'formatted_phone_number', 'geometry']
};

service = new google.maps.places.PlacesService(map);
service.getDetails(request, callback);

function callback(place, status) {
  if (status == google.maps.places.PlacesServiceStatus.OK) {
    createMarker(place);
  }
}












//MICKEY
// var userLat;
// var userLong;


// function getLocation() {
//    if (navigator.geolocation) {
//      navigator.geolocation.getCurrentPosition(showPosition, positionError);
//      console.log(getLocation);
//    //   console.log(getLocation/coord);
//    } else {
//      console.log("Geolocation is not supported by this browser.");
//    }
//  }
       
// function showPosition(position) {
//   //console.log(position)
//   // Success, can use position.
//   console.log("Your position is: " + position);
//   //setting user coordinates for the variables         
//   userLat = position.coords.latitude;
//   userLong = position.coords.longitude;
//   console.log(userLat);
//   console.log(userLong);
//    //sending the coordinate variables defined here to a new functions called "directions" and when making the map
//   directions(userLat, userLong);
//   initMap(userLat, userLong);
// }

       

// //If user doesn't want to give access to location
// function positionError(error) {
//   if (error.PERMISSION_DENIED) {
//     console.log("Error: permission denied");
//     // Your custom modal here.
//     showError('Geolocation is not enabled. Please enable to use this feature.');
//   } else {
//       // Handle other kinds of errors.
//       console.log("Other kind of error: " + error);
//     }
// }
       
//        function showError(message) {
//          // TODO
//        }
       
// getLocation();
       
// // this makes the map and centers user's viewport in that area
// var map;
// function initMap(newLat, newLong) {
//   var center = new google.maps.LatLng(newLat, newLong);
//   map = new google.maps.Map(document.getElementById('map'), {
//     center: {lat: newLat, lng: newLong},
//     zoom: 14
//   });
//   var request = {
//     location: center,
//     radius: 24140,
//     types: ["restaurant"]
//   };
//   //use google Places to search for "restaurant" on the map:
//   var service = new google.maps.places.PlacesService(map);

//   service.nearbySearch(request, callback);
// }

// //ensure PlacesService worked
// function callback(results, status) {
//   if(status === google.maps.places.PlacesService.OK){
//     for (var i = 0; i < results.length; i++){
//       createMarker(results[i]);
//     }
//   }
// }

// //put a map marker down on each restaurant in that area
// function createMarker(place) {
//   var placeLoc = place.geometry.location;
//   var maker = new google.maps.Marker({
//     map: map,
//     position: place.geometry.location
//   });
// }

// //lat and long are parameters taken from showPosition function when it was fed/sent.
// //this function won't be used until the coordinates have been defined in showPosition and sent to this function
// function directions(lat, long){
//   console.log(lat)
//   console.log(long)
//      }



</script>
</body>
</html>
